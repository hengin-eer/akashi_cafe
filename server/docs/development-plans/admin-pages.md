# 管理者ページ実装計画書

## 概要

明石高専学生食堂システムの管理者機能を実装するための詳細計画書です。管理者はメニューの管理、CSVインポート、個別編集機能を使用できます。

## 1. 管理者トップページ (`/admin`) の実装

### UI設計
- ページ中央に「メニュー管理」の大きなカードを配置
- カードには「月別メニューの管理・追加・削除」の説明文を表示
- カードクリック時に `/admin/menu` にページ遷移
- 将来機能拡張用のプレースホルダーカード（グレーアウト）を配置

### 実装手法
- Svelteの`{#each}`ブロックで管理機能一覧を動的に生成
- 各カードは`<a>`タグで囲み、CSSでカード風のデザインを適用
- ホバー時のエフェクト（影の拡大、色の変化）をCSS transitionで実装
- レスポンシブデザインでモバイル対応（CSS Grid使用）

### 認証チェック
- ページ読み込み時（`onMount`）に管理者権限APIをコール
- 権限がない場合は自動的にログインページにリダイレクト
- エラー時は「権限がありません」のメッセージを表示

## 2. メニュー管理ページ (`/admin/menu`) の実装

### データ取得処理
- ページ読み込み時にバックエンドの `/api/admin/menus/summary` をコール
- レスポンス例: `[{month: "2025-01", count: 25, last_updated: "2025-01-15"}]`
- データを`menuList`変数に格納し、リアクティブに表示更新

### UI表示ロジック
- 月ごとにカード形式で表示（最新月が上位）
- 各カードには以下を表示：
  - 月（例：「2025年1月のメニュー」）
  - メニュー件数（例：「25件のメニュー」）
  - 最終更新日
  - 「詳細」ボタンと「削除」ボタン

### 削除機能の実装
- 削除ボタンクリック時に確認ダイアログを表示
- ダイアログのメッセージ：「2025年1月のメニュー（25件）を全て削除しますか？」
- 「はい」選択時に `/api/admin/menus/{month}` へDELETEリクエスト送信
- 削除処理中はボタンを無効化し、スピナーを表示
- 削除完了後にページを再読み込みしてリストを更新

### エラーハンドリング
- API呼び出し失敗時は赤いバナーでエラーメッセージを表示
- タイムアウト時は「サーバーとの通信に時間がかかっています」を表示
- ネットワークエラー時は「接続エラー：インターネット接続を確認してください」を表示

## 3. メニュー新規作成ページ (`/admin/menu/create`) の実装

### フォーム設計
- 上部に月選択ドロップダウン（現在月から6ヶ月先まで選択可能）
- CSVファイルアップロードエリア（ドラッグ&ドロップ対応）
- ファイル選択後にプレビューエリアを表示
- 「インポート開始」ボタン（月とファイルが選択された時のみ有効）

### CSVファイル処理
1. **ファイル選択時の処理**
   - ファイル拡張子チェック（.csvのみ許可）
   - ファイルサイズチェック（5MB以下）
   - 選択されたファイル名を表示

2. **プレビュー機能**
   - CSVの最初の5行を読み込んでテーブル形式で表示
   - 必須カラムの存在チェック（date, type, name, price, energy, protein, fat, carb, salt, allergens）
   - カラム不足時は赤いエラーメッセージを表示

3. **インポート処理**
   - 「インポート開始」ボタンクリック時にFormDataでファイルをPOST送信
   - バックエンドは非同期でCSV処理を開始し、処理IDを返却
   - フロントエンドは1秒間隔で進捗確認API `/api/admin/import/{process_id}/status` をポーリング

### プログレスバー表示
- 処理開始時にプログレスバーエリアを表示
- 進捗状況を以下の段階で表示：
  - 「ファイル解析中...」（0-20%）
  - 「データ検証中...」（20-40%）
  - 「データベース登録中...」（40-90%）
  - 「完了処理中...」（90-100%）
- 各段階でバックエンドから返される進捗率でバーを更新

### 結果表示
- 成功時：「25件のメニューを正常に登録しました」の緑のメッセージ
- 部分失敗時：「20件成功、5件失敗しました。詳細を確認してください」の黄色のメッセージ
- 完全失敗時：「インポートに失敗しました」の赤のメッセージ
- 結果表示後に「メニュー詳細を見る」「メニュー管理に戻る」ボタンを表示

## 4. 月別メニュー詳細ページ (`/admin/menu/:month`) の実装

### データ表示
- 指定月のメニューを `/api/admin/menus/{month}/details` から取得
- テーブル形式で以下のカラムを表示：
  - 日付、種別（主菜・副菜等）、メニュー名、価格、カロリー、アレルゲン
- テーブルはソート機能付き（日付、価格、カロリーでソート可能）
- 1ページ50件で表示し、ページネーション機能を実装

### 個別メニュー追加機能
- ページ上部に「メニュー追加」ボタンを配置
- クリック時にモーダルダイアログを表示
- モーダル内にCSV形式の入力テキストエリアを配置
- 入力例：`2025-01-15,主菜,唐揚げ定食,650,720,25.5,18.2,85.3,2.8,鶏肉・小麦`
- 「追加」ボタンクリック時にCSVパースし、バリデーション実行
- 成功時はモーダルを閉じてテーブルを更新

### 削除機能
- 各行に削除ボタン（ゴミ箱アイコン）を配置
- クリック時に確認ダイアログ：「『唐揚げ定食』を削除しますか？」
- 削除確定時に `/api/admin/menus/item/{menu_id}` へDELETEリクエスト
- 削除後は該当行をテーブルから即座に削除（再読み込み不要）

### 一括操作機能
- テーブルヘッダーにチェックボックスを配置（全選択用）
- 各行にもチェックボックスを配置
- 選択された行に対して「選択削除」ボタンで一括削除実行
- 削除時は「5件のメニューを削除しますか？」の確認ダイアログ表示

## 5. バックエンドAPI設計

### 管理者権限チェック
- 全ての管理者APIで `@require_admin` デコレータを適用
- デコレータ内でセッション確認 → 管理者権限確認の順で実行
- 権限がない場合は403エラーを返却

### CSVインポート処理
1. **ファイル受信** (`POST /api/admin/menus/import`)
   - multipart/form-dataでファイルを受信
   - 一時ディレクトリにファイルを保存
   - 非同期タスクでCSV処理を開始
   - 処理IDを生成してクライアントに返却

2. **進捗管理**
   - Redisまたはデータベースで進捗状況を管理
   - 処理状況：waiting, parsing, validating, inserting, completed, failed
   - 進捗率、処理済み件数、エラー件数を記録

3. **データ検証**
   - 必須カラムの存在確認
   - データ型チェック（価格は数値、日付は正しい形式等）
   - 重複チェック（同日同種別の重複メニューを検出）
   - エラー行は詳細ログに記録

### エラーログ機能
- インポート失敗時の詳細ログをデータベースに保存
- 行番号、エラー理由、データ内容を記録
- 管理者画面でエラーログの閲覧機能を提供

## 6. セキュリティ対策

### ファイルアップロード
- ファイル拡張子の厳格チェック（.csvのみ許可）
- ファイルサイズ制限（5MB以下）
- アップロードディレクトリの実行権限削除
- 一時ファイルの自動削除（処理完了後30分で削除）

### 権限管理
- 管理者権限は専用テーブルで管理
- 権限の付与・削除ログを記録
- セッションタイムアウトを短めに設定（2時間）

### データ検証
- SQLインジェクション対策（パラメータ化クエリ使用）
- XSS対策（入力データのエスケープ処理）
- CSRF対策（トークン認証）

## 7. パフォーマンス最適化

### フロントエンド
- テーブルデータの仮想スクロール（大量データ対応）
- 画像遅延読み込み（メニュー写真がある場合）
- キャッシュ機能（メニューリストを5分間キャッシュ）

### バックエンド
- CSVインポートの並列処理（チャンク単位で処理）
- データベースインデックスの最適化
- 重いクエリの結果キャッシュ

この計画書に従って段階的に実装を進めることで、使いやすく安全な管理者機能を構築できます。
